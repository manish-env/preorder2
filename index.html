<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
  <title>Preorder Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://unpkg.com/vue@3.3.4/dist/vue.global.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
    * { box-sizing: border-box; }
    body { 
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
      margin: 0; 
      padding: 0; 
      background: #0f0f0f;
      min-height: 100vh;
      color: #ffffff;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .header {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      padding: 32px;
      margin-bottom: 32px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }
    
    .header h1 {
      margin: 0 0 20px 0;
      color: #ffffff;
      font-size: 32px;
      font-weight: 800;
      letter-spacing: -0.5px;
    }
    
    .header-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 16px;
    }
    
    .search-container {
      position: relative;
      flex: 1;
      max-width: 400px;
      margin-right: 16px;
    }
    
    .search-input {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.05);
      color: #ffffff;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s ease;
    }
    
    .search-input:focus {
      outline: none;
      border-color: #ffffff;
      background: rgba(255, 255, 255, 0.1);
      box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.1);
    }
    
    .search-input::placeholder {
      color: rgba(255, 255, 255, 0.5);
    }
    
    .search-suggestions {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: rgba(0, 0, 0, 0.95);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      margin-top: 4px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 1000;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }
    
    .suggestion-item {
      padding: 12px 16px;
      cursor: pointer;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      transition: background 0.2s ease;
    }
    
    .suggestion-item:hover {
      background: rgba(255, 255, 255, 0.05);
    }
    
    .suggestion-item:last-child {
      border-bottom: none;
    }
    
    .suggestion-title {
      color: #ffffff;
      font-weight: 500;
      font-size: 14px;
    }
    
    .suggestion-type {
      color: rgba(255, 255, 255, 0.5);
      font-size: 12px;
      margin-top: 2px;
    }
    
    .stats {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
    }
    
    .stat-card {
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.15);
      color: #ffffff;
      padding: 16px 24px;
      border-radius: 16px;
      font-weight: 600;
      font-size: 14px;
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
    }
    
    .stat-card:hover {
      background: rgba(255, 255, 255, 0.12);
      transform: translateY(-2px);
    }
    
    .btn {
      background: #ffffff;
      color: #000000;
      border: none;
      padding: 14px 28px;
      border-radius: 14px;
      font-weight: 700;
      font-size: 15px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 10px;
      letter-spacing: 0.5px;
    }
    
    .btn:hover:not(:disabled) {
      transform: translateY(-3px);
      box-shadow: 0 12px 40px rgba(255, 255, 255, 0.2);
      background: #f8f9fa;
    }
    
    .btn:disabled {
      background: rgba(255, 255, 255, 0.2);
      color: rgba(255, 255, 255, 0.5);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .message {
      margin: 16px 0;
      padding: 16px;
      border-radius: 12px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .message.success {
      background: rgba(34, 197, 94, 0.2);
      border: 1px solid rgba(34, 197, 94, 0.3);
      color: #22c55e;
    }
    
    .message.error {
      background: rgba(239, 68, 68, 0.2);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: #ef4444;
    }
    
    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 60px;
      color: white;
      font-size: 18px;
      font-weight: 500;
    }
    
    .spinner {
      width: 24px;
      height: 24px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-top: 3px solid white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 12px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    @keyframes slideIn {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(0%); }
    }
    
    .products-grid {
      display: grid;
      gap: 24px;
    }
    
    .product-card {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      padding: 32px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      transition: all 0.3s ease;
    }
    
    .product-card:hover {
      transform: translateY(-6px);
      background: rgba(255, 255, 255, 0.08);
      border-color: rgba(255, 255, 255, 0.2);
    }
    
    .product-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 12px;
    }
    
    .product-title {
      font-size: 22px;
      font-weight: 700;
      color: #ffffff;
      margin: 0;
      letter-spacing: -0.3px;
    }
    
    .product-id {
      color: rgba(255, 255, 255, 0.6);
      font-size: 14px;
      font-weight: 500;
      margin-top: 4px;
    }
    
    .variants-table {
      width: 100%;
      border-collapse: collapse;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      overflow: hidden;
      backdrop-filter: blur(10px);
    }
    
    .variants-table th {
      background: rgba(255, 255, 255, 0.08);
      color: #ffffff;
      padding: 20px 16px;
      text-align: left;
      font-weight: 700;
      font-size: 14px;
      letter-spacing: 0.5px;
      text-transform: uppercase;
    }
    
    .variants-table td {
      padding: 20px 16px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      vertical-align: middle;
      color: #ffffff;
    }
    
    .variants-table tr:last-child td {
      border-bottom: none;
    }
    
    .variants-table tr:hover td {
      background: rgba(255, 255, 255, 0.02);
    }
    
    .variant-info {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    
    .variant-title {
      font-weight: 600;
      color: #ffffff;
      font-size: 15px;
    }
    
    .variant-id {
      color: rgba(255, 255, 255, 0.5);
      font-size: 12px;
      font-weight: 500;
    }
    
    .stock-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .stock-badge.in-stock {
      background: rgba(34, 197, 94, 0.2);
      border: 1px solid rgba(34, 197, 94, 0.3);
      color: #22c55e;
    }
    
    .stock-badge.out-of-stock {
      background: rgba(239, 68, 68, 0.2);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: #ef4444;
    }
    
    .toggle-switch {
      position: relative;
      width: 54px;
      height: 28px;
      background: rgba(255, 255, 255, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .toggle-switch.active {
      background: rgba(34, 197, 94, 0.8);
      border-color: #22c55e;
    }
    
    .toggle-switch::after {
      content: '';
      position: absolute;
      top: 3px;
      left: 3px;
      width: 20px;
      height: 20px;
      background: #ffffff;
      border-radius: 50%;
      transition: transform 0.3s ease;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }
    
    .toggle-switch.active::after {
      transform: translateX(26px);
    }
    
    .number-input {
      width: 80px;
      padding: 10px 14px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      text-align: center;
      background: rgba(255, 255, 255, 0.05);
      color: #ffffff;
      transition: all 0.3s ease;
    }
    
    .number-input:focus {
      outline: none;
      border-color: #ffffff;
      background: rgba(255, 255, 255, 0.1);
    }
    
    .number-input::placeholder {
      color: rgba(255, 255, 255, 0.4);
    }
    
    .sold-qty {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      color: #ffffff;
    }
    
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: white;
    }
    
    .empty-state i {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.7;
    }
    
    .load-more-container {
      text-align: center;
      margin: 32px 0;
    }
    
    .load-more-btn {
      background: rgba(255, 255, 255, 0.1);
      color: #ffffff;
      border: 1px solid rgba(255, 255, 255, 0.2);
      padding: 16px 32px;
      border-radius: 16px;
      font-weight: 600;
      font-size: 15px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 10px;
    }
    
    .load-more-btn:hover:not(:disabled) {
      background: rgba(255, 255, 255, 0.15);
      border-color: rgba(255, 255, 255, 0.3);
      transform: translateY(-2px);
    }
    
    .load-more-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    
    .pagination-info {
      color: rgba(255, 255, 255, 0.7);
      font-size: 14px;
      margin-top: 16px;
    }
    
    .search-results-info {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .search-results-count {
      color: #ffffff;
      font-weight: 600;
    }
    
    .clear-search-btn {
      background: rgba(255, 255, 255, 0.1);
      color: #ffffff;
      border: 1px solid rgba(255, 255, 255, 0.2);
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .clear-search-btn:hover {
      background: rgba(255, 255, 255, 0.15);
    }
    
    @media (max-width: 768px) {
      .container {
        padding: 16px;
      }
      
      .header-controls {
        flex-direction: column;
        align-items: stretch;
      }
      
      .stats {
        justify-content: center;
      }
      
      .variants-table {
        font-size: 14px;
      }
      
      .variants-table th,
      .variants-table td {
        padding: 12px 8px;
      }
      
      .product-header {
        flex-direction: column;
        align-items: stretch;
      }
    }
    </style>
</head>
<body>
  <div id="app">
    <div class="container">
      <div class="header">
        <h1><i class="fas fa-shopping-cart"></i> Preorder Dashboard</h1>
        <div class="header-controls">
          <div class="search-container">
            <input 
              type="text" 
              class="search-input" 
              v-model="searchQuery" 
              @input="onSearchInput"
              @keyup.enter="performSearch"
              @focus="showSuggestions = true"
              @blur="hideSuggestions"
              placeholder="Search products..."
            >
            <div v-if="showSuggestions && searchSuggestions.length > 0" class="search-suggestions">
              <div 
                v-for="suggestion in searchSuggestions" 
                :key="suggestion.id"
                class="suggestion-item"
                @click="selectSuggestion(suggestion)"
              >
                <div class="suggestion-title">{{ suggestion.title }}</div>
                <div class="suggestion-type">{{ suggestion.variants }} variants</div>
              </div>
            </div>
          </div>
          <div class="stats">
            <div class="stat-card">
              <i class="fas fa-boxes"></i> {{ totalProducts }} Products
            </div>
            <div class="stat-card">
              <i class="fas fa-layer-group"></i> {{ totalVariants }} Variants
            </div>
            <div class="stat-card">
              <i class="fas fa-toggle-on"></i> {{ enabledPreorders }} Enabled
            </div>
          </div>
          <button class="btn" @click="saveChanges" :disabled="!Object.keys(changes).length || saving">
            <i class="fas" :class="saving ? 'fa-spinner fa-spin' : 'fa-save'"></i>
            {{ saving ? 'Saving...' : 'Save Changes' }}
          </button>
        </div>
      </div>

      <div v-if="message" :class="['message', messageType]">
        <i class="fas" :class="messageType === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'"></i>
        {{ message }}
      </div>

      <div v-if="loading" class="loading">
        <div class="spinner"></div>
        <div style="margin-top: 20px; text-align: center;">
          <div>Loading products and preorder settings...</div>
          <div style="width: 300px; height: 6px; background: rgba(255,255,255,0.2); border-radius: 3px; margin: 10px auto; overflow: hidden;">
            <div style="width: 100%; height: 100%; background: linear-gradient(90deg, #22c55e, #16a34a); border-radius: 3px; transform: translateX(-100%); animation: slideIn 2s ease-out forwards; animation-delay: 0.5s;"></div>
          </div>
          <div style="font-size: 14px; opacity: 0.8;">{{ Math.round(loadingProgress) }}%</div>
        </div>
      </div>

      <div v-else-if="products.length === 0" class="empty-state">
        <i class="fas fa-box-open"></i>
        <h3>No products found</h3>
        <p>Your Shopify store doesn't have any products yet.</p>
      </div>

      <div v-else>
        <!-- Search Results Info -->
        <div v-if="searchQuery" class="search-results-info">
          <div class="search-results-count">
            <i class="fas fa-search"></i>
            {{ pagination.total }} results for "{{ searchQuery }}"
          </div>
          <button class="clear-search-btn" @click="clearSearch">
            <i class="fas fa-times"></i> Clear
        </button>
    </div>

        <div class="products-grid">
          <div v-for="p in products" :key="p.id" class="product-card">
          <div class="product-header">
            <div>
              <h3 class="product-title">{{ p.title }}</h3>
              <div class="product-id">Product ID: {{ p.id }}</div>
            </div>
    </div>

          <table class="variants-table">
                <thead>
                    <tr>
                <th><i class="fas fa-tag"></i> Variant</th>
                <th><i class="fas fa-warehouse"></i> Stock</th>
                <th><i class="fas fa-toggle-on"></i> Preorder</th>
                <th><i class="fas fa-hashtag"></i> Limit</th>
                <th><i class="fas fa-chart-line"></i> Sold</th>
                    </tr>
                </thead>
                <tbody>
            <tr v-for="v in p.variants" :key="v.id">
                <td>
                  <div class="variant-info">
                    <div class="variant-title">{{ v.title }}</div>
                    <div class="variant-id">{{ v.id }}</div>
                  </div>
                        </td>
                <td>
                  <span class="stock-badge" :class="v.inventoryQuantity > 0 ? 'in-stock' : 'out-of-stock'">
                    <i class="fas" :class="v.inventoryQuantity > 0 ? 'fa-check' : 'fa-times'"></i>
                    {{ v.inventoryQuantity }}
                            </span>
                        </td>
                <td>
                  <div class="toggle-switch" 
                       :class="{ active: (v.isPreorder && v.isPreorder.value) }"
                       @click="togglePreorder(v.id, !(v.isPreorder && v.isPreorder.value))">
                  </div>
                        </td>
                <td>
                  <input type="number" 
                         class="number-input" 
                         :value="(v.preorderLimit && v.preorderLimit.value) || 0" 
                         @input="updateChange(v.id,'preorderLimit',$event.target.value)"
                         min="0"
                         placeholder="0">
                        </td>
                <td>
                  <span class="sold-qty">
                    <i class="fas fa-shopping-bag"></i>
                    {{ v.sold || 0 }}
                  </span>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        </div>

        <!-- Load More Button and Pagination Info -->
        <div v-if="pagination.hasMore || searchQuery" class="load-more-container">
          <button 
            v-if="pagination.hasMore" 
            class="load-more-btn" 
            @click="loadMore" 
            :disabled="loadingMore"
          >
            <i class="fas" :class="loadingMore ? 'fa-spinner fa-spin' : 'fa-plus'"></i>
            {{ loadingMore ? 'Loading...' : 'Load More Products' }}
          </button>
          <div v-if="!pagination.hasMore && products.length > 0" class="pagination-info">
            <i class="fas fa-check-circle"></i>
            Showing all {{ products.length }} products
          </div>
        </div>
        </div>
    </div>
</div>

<script>
    const { createApp } = Vue;
    createApp({
      data() { 
        return { 
          products: [], 
          changes: {}, 
          loading: true, 
          saving: false, 
          message: '', 
          messageType: '',
          loadingProgress: 0,
          // Pagination
          pagination: {
            page: 1,
            limit: 30,
            total: 0,
            hasMore: false,
            nextPage: null
          },
          // Search
          searchQuery: '',
          searchSuggestions: [],
          showSuggestions: false,
          searchTimeout: null,
          // Load more
          loadingMore: false
        }; 
      },
      computed: {
        totalProducts() {
          return this.products.length;
        },
        totalVariants() {
          return this.products.reduce((total, product) => total + product.variants.length, 0);
        },
        enabledPreorders() {
          return this.products.reduce((total, product) => {
            return total + product.variants.filter(v => v.isPreorder && v.isPreorder.value).length;
          }, 0);
        }
      },
      async mounted() { await this.fetchProducts(); },
      methods: {
        async fetchProducts(reset = true) {
          if (reset) {
            this.loading = true;
            this.loadingProgress = 0;
            this.products = [];
            this.pagination.page = 1;
          } else {
            this.loadingMore = true;
          }
          
          // Simulate progress updates
          const progressInterval = setInterval(() => {
            if (this.loadingProgress < 90) {
              this.loadingProgress += Math.random() * 20;
            }
          }, 200);
          
          try { 
            const params = new URLSearchParams({
              page: this.pagination.page,
              limit: this.pagination.limit
            });
            
            if (this.searchQuery) {
              params.append('search', this.searchQuery);
            }
            
            const res = await axios.get(`/api/products?${params}`); 
            const data = res.data;
            
            if (reset) {
              this.products = data.products || data || [];
            } else {
              this.products = [...this.products, ...(data.products || data || [])];
            }
            
            this.pagination = data.pagination || this.pagination;
            this.loadingProgress = 100;
          }
          catch(e){ 
            this.message = `Error loading products: ${e.response?.data?.error || e.message}`;
            this.messageType = 'error';
            console.error(e); 
          }
          finally {
            clearInterval(progressInterval);
            setTimeout(() => {
              this.loading = false;
              this.loadingMore = false;
              this.loadingProgress = 0;
            }, 500);
          }
        },
        updateChange(vid, field, value) {
          if (!this.changes[vid]) this.changes[vid] = {};
          this.changes[vid][field] = value;
        },
        togglePreorder(vid, enabled) {
          console.log(`Toggling preorder for variant ${vid}: ${enabled}`);
          this.updateChange(vid, 'isPreorder', enabled);
          
          // Update the UI immediately for better UX
          const product = this.products.find(p => p.variants.some(v => v.id === vid));
          if (product) {
            const variant = product.variants.find(v => v.id === vid);
            if (variant) {
              if (!variant.isPreorder) variant.isPreorder = { value: false };
              variant.isPreorder.value = enabled;
            }
          }
        },
        hasActivePreorders(product) {
          if (!product.variants) return false;
          return product.variants.some(v => v.isPreorder && v.isPreorder.value);
        },
        async saveChanges() {
          this.saving = true;
          this.message = '';
          this.messageType = '';
          
          const items = Object.keys(this.changes).map(vid => {
            const ch = this.changes[vid];
            return { 
              id: vid, 
              isPreorder: ch.isPreorder, 
              preorderLimit: parseInt(ch.preorderLimit || 0, 10) 
            };
          });
          
          console.log('Saving changes:', items);
          
          try { 
            const response = await axios.post("/api/update-metafields", items);
            const result = response.data;
            
            console.log('API Response:', result);
            
            if (result.success) {
              this.message = `✅ Successfully saved ${items.length} variant(s)! Metafields updated in Shopify.`;
              this.messageType = 'success';
            } else {
              this.message = `⚠️ Save completed with some issues.`;
              this.messageType = 'error';
            }
            
            this.changes = {};
            await this.fetchProducts();
            
            // Clear success message after 5 seconds
            setTimeout(() => {
              this.message = '';
              this.messageType = '';
            }, 5000);
          }
          catch(e){ 
            console.error('Save error details:', e);
            this.message = `Save failed: ${e.response?.data?.error || e.message || 'Network Error'}`;
            this.messageType = 'error';
          }
          finally {
            this.saving = false;
          }
        },
        
        // Search functionality
        onSearchInput() {
          clearTimeout(this.searchTimeout);
          this.searchTimeout = setTimeout(() => {
            this.searchSuggestions = [];
            if (this.searchQuery.length >= 2) {
              this.fetchSearchSuggestions();
            }
          }, 300);
        },
        
        async fetchSearchSuggestions() {
          try {
            const res = await axios.get(`/api/search-suggestions?q=${encodeURIComponent(this.searchQuery)}`);
            this.searchSuggestions = res.data || [];
          } catch (e) {
            console.error('Search suggestions error:', e);
            this.searchSuggestions = [];
          }
        },
        
        selectSuggestion(suggestion) {
          this.searchQuery = suggestion.title;
          this.showSuggestions = false;
          this.searchSuggestions = [];
          this.performSearch();
        },
        
        async performSearch() {
          this.pagination.page = 1;
          await this.fetchProducts(true);
        },
        
        clearSearch() {
          this.searchQuery = '';
          this.searchSuggestions = [];
          this.showSuggestions = false;
          this.pagination.page = 1;
          this.fetchProducts(true);
        },
        
        hideSuggestions() {
          setTimeout(() => {
            this.showSuggestions = false;
          }, 200);
        },
        
        // Load more functionality
        async loadMore() {
          this.pagination.page += 1;
          await this.fetchProducts(false);
        }
      }
    }).mount("#app");
</script>
</body>
</html>